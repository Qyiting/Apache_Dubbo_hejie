<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>RPC Provider ç›‘æ§ç®¡ç†ç•Œé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .content {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            min-height: 500px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #666;
        }

        .status-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #4facfe;
        }

        .metric-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .metric-unit {
            font-size: 12px;
            color: #999;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .health-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .health-up {
            background: #d4edda;
            color: #155724;
        }

        .health-down {
            background: #f8d7da;
            color: #721c24;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .connected {
            background: #d4edda;
            color: #155724;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .nav {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-btn {
                width: 200px;
                text-align: center;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">è¿æ¥ä¸­...</div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸš€ RPC Provider ç›‘æ§ä¸­å¿ƒ</h1>
            <p>å®æ—¶ç›‘æ§æ‚¨çš„RPCæœåŠ¡çŠ¶æ€</p>
        </div>
        
        <div class="nav">
            <button class="nav-btn active" onclick="loadContent('overview', this)">ğŸ“Š æœåŠ¡æ¦‚è§ˆ</button>
            <button class="nav-btn" onclick="loadContent('health', this)">ğŸ’š å¥åº·æ£€æŸ¥</button>
            <button class="nav-btn" onclick="loadContent('config', this)">âš™ï¸ é…ç½®ç®¡ç†</button>
            <button class="nav-btn" onclick="loadContent('logs', this)">ğŸ“‹ æ—¥å¿—æŸ¥çœ‹</button>
            <button class="nav-btn" onclick="loadContent('instances', this)">ğŸ”§ å®ä¾‹ç®¡ç†</button>
        </div>
        
        <div class="content" id="content">
            <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectTimer = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadOverviewData();
            initWebSocket();
        });
        
        // WebSocketè¿æ¥
        function initWebSocket() {
            try {
                // åŠ¨æ€è·å–å½“å‰é¡µé¢çš„ç«¯å£
                const currentPort = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
                const wsUrl = `ws://${window.location.hostname}:${currentPort}/ws/monitoring`;
                console.log('è¿æ¥WebSocket:', wsUrl);
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                    showConnectionStatus(true);
                    if (reconnectTimer) {
                        clearInterval(reconnectTimer);
                        reconnectTimer = null;
                    }
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        updateRealTimeData(data);
                    } catch (e) {
                        console.error('è§£æWebSocketæ•°æ®å¤±è´¥:', e);
                    }
                };
                
                ws.onclose = function() {
                    console.log('WebSocketè¿æ¥å·²å…³é—­');
                    showConnectionStatus(false);
                    // è‡ªåŠ¨é‡è¿
                    if (!reconnectTimer) {
                        reconnectTimer = setInterval(() => {
                            console.log('å°è¯•é‡æ–°è¿æ¥WebSocket...');
                            initWebSocket();
                        }, 5000);
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocketé”™è¯¯:', error);
                    showConnectionStatus(false);
                };
            } catch (e) {
                console.error('WebSocketåˆå§‹åŒ–å¤±è´¥:', e);
                showConnectionStatus(false);
            }
        }
        
        // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
        function showConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.textContent = 'ğŸŸ¢ å·²è¿æ¥';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = 'ğŸ”´ å·²æ–­å¼€';
                statusEl.className = 'connection-status disconnected';
            }
        }
        
        // æ›´æ–°å®æ—¶æ•°æ®
        function updateRealTimeData(data) {
            console.log('æ”¶åˆ°WebSocketæ•°æ®:', data);
            
            // æ›´æ–°å†…å­˜ä½¿ç”¨ç‡
            const memoryUsageEl = document.getElementById('memory-usage');
            if (memoryUsageEl && data.memory) {
                const totalMemory = data.memory.total || 0;
                const freeMemory = data.memory.free || 0;
                const usedMemory = data.memory.used || (totalMemory - freeMemory);
                const usagePercent = data.memory.usagePercent || (totalMemory > 0 ? ((usedMemory / totalMemory) * 100).toFixed(1) : 0);
                
                memoryUsageEl.innerHTML = `
                    <div class="metric-title">ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡</div>
                    <div class="metric-value">${usagePercent.toFixed(1)}%</div>
                    <div class="metric-unit">${formatBytes(usedMemory)} / ${formatBytes(totalMemory)}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${usagePercent}%"></div>
                    </div>
                `;
            }
            
            // æ›´æ–°çº¿ç¨‹æ•°
            const threadCountEl = document.getElementById('thread-count');
            if (threadCountEl && data.threads) {
                threadCountEl.innerHTML = `
                    <div class="metric-title">æ´»è·ƒçº¿ç¨‹æ•°</div>
                    <div class="metric-value">${data.threads.count || 0}</div>
                    <div class="metric-unit">å³°å€¼: ${data.threads.peak || 0}</div>
                `;
            }
            
            // æ›´æ–°RPCç»Ÿè®¡
            const rpcStatsEl = document.getElementById('rpc-stats');
            if (rpcStatsEl && data.rpc) {
                rpcStatsEl.innerHTML = `
                    <div class="metric-title">RPCè°ƒç”¨ç»Ÿè®¡</div>
                    <div class="metric-value">${data.rpc.totalCalls || 0}</div>
                    <div class="metric-unit">æ€»è°ƒç”¨æ¬¡æ•°</div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        æˆåŠŸ: ${data.rpc.successCalls || 0} | å¤±è´¥: ${data.rpc.failedCalls || 0}<br>
                        å½“å‰è¿æ¥: ${data.rpc.currentConnections || 0} | å¹³å‡å“åº”: ${data.rpc.avgResponseTime || 0}ms
                    </div>
                `;
            }
            
            // æ›´æ–°æœåŠ¡æ³¨å†Œæ•°
            const serviceRegistrationsEl = document.getElementById('serviceRegistrationsValue');
            if (serviceRegistrationsEl && data.rpc && data.rpc.serviceRegistrations !== undefined) {
                serviceRegistrationsEl.textContent = data.rpc.serviceRegistrations;
            }
            
            // æ›´æ–°å¥åº·çŠ¶æ€
            const healthStatusEl = document.getElementById('health-status');
            if (healthStatusEl && data.health) {
                const status = data.health.status || 'UNKNOWN';
                const statusColor = status === 'UP' ? '#4CAF50' : status === 'WARNING' ? '#FF9800' : '#F44336';
                healthStatusEl.innerHTML = `
                    <div class="metric-title">æœåŠ¡å¥åº·çŠ¶æ€</div>
                    <div class="metric-value" style="color: ${statusColor}">${status}</div>
                    <div class="metric-unit">å†…å­˜: ${data.health.memoryStatus || 'UNKNOWN'}</div>
                `;
            }
        }
        
        // æ ¼å¼åŒ–å­—èŠ‚æ•°
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // åŠ è½½å†…å®¹
        function loadContent(type, element) {
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            if (element) element.classList.add('active');
            
            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>';
            
            switch(type) {
                case 'overview':
                    loadOverviewData();
                    break;
                case 'health':
                    loadHealthData();
                    break;
                case 'config':
                    loadConfigData();
                    break;
                case 'logs':
                    loadLogsData();
                    break;
                case 'instances':
                    loadInstancesData();
                    break;
            }
        }
        
        // åŠ è½½æ¦‚è§ˆæ•°æ®
        function loadOverviewData() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="status-card">
                    <h2>ğŸš€ RPC Provider æœåŠ¡çŠ¶æ€</h2>
                    <p>æœåŠ¡è¿è¡Œæ­£å¸¸ï¼Œç›‘æ§æ•°æ®å®æ—¶æ›´æ–°ä¸­...</p>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card" id="memory-usage">
                        <div class="metric-title">ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡</div>
                        <div class="metric-value">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <div class="metric-card" id="thread-count">
                        <div class="metric-title">æ´»è·ƒçº¿ç¨‹æ•°</div>
                        <div class="metric-value">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <div class="metric-card" id="rpc-stats">
                        <div class="metric-title">RPCè°ƒç”¨ç»Ÿè®¡</div>
                        <div class="metric-value">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <div class="metric-card" id="service-registrations">
                        <div class="metric-title">æœåŠ¡æ³¨å†Œæ•°</div>
                        <div class="metric-value" id="serviceRegistrationsValue">0</div>
                        <div class="metric-unit">ä¸ªæœåŠ¡</div>
                    </div>
                </div>
            `;
            
            // ç«‹å³åˆ·æ–°æ•°æ®
            refreshData();
        }
        
        // åŠ è½½å¥åº·æ£€æŸ¥æ•°æ®
        function loadHealthData() {
            fetch('/api/management/health')
                .then(response => response.json())
                .then(data => {
                    const content = document.getElementById('content');
                    
                    // è®¡ç®—å†…å­˜ä½¿ç”¨ç‡
                    let memoryUsage = '0%';
                    let memoryDetails = 'æ— æ•°æ®';
                    let memoryPercent = 0;
                    
                    if (data.system && data.system.totalMemory && data.system.freeMemory) {
                        const totalMemory = data.system.totalMemory;
                        const freeMemory = data.system.freeMemory;
                        const usedMemory = totalMemory - freeMemory;
                        memoryPercent = ((usedMemory / totalMemory) * 100).toFixed(1);
                        memoryUsage = memoryPercent + '%';
                        memoryDetails = `${formatBytes(usedMemory)} / ${formatBytes(totalMemory)}`;
                    }
                    
                    content.innerHTML = `
                        <h2>ğŸ’š ç³»ç»Ÿå¥åº·çŠ¶æ€</h2>
                        
                        <div class="metrics-grid">
                            <div class="metric-card" id="health-memory-usage">
                                <div class="metric-title">ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡</div>
                                <div class="metric-value">${memoryUsage}</div>
                                <div class="metric-unit">${memoryDetails}</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${memoryPercent}%"></div>
                                </div>
                            </div>
                            
                            <div class="metric-card" id="health-thread-count">
                                <div class="metric-title">æ´»è·ƒçº¿ç¨‹æ•°</div>
                                <div class="metric-value">${data.threads ? data.threads.count : 0}</div>
                                <div class="metric-unit">å³°å€¼: ${data.threads ? data.threads.peakCount : 0}</div>
                            </div>
                            
                            <div class="metric-card" id="health-rpc-stats">
                                <div class="metric-title">RPCè°ƒç”¨ç»Ÿè®¡</div>
                                <div class="metric-value">${data.rpcStats ? data.rpcStats.totalCalls : 0}</div>
                                <div class="metric-unit">æ€»è°ƒç”¨æ¬¡æ•°</div>
                                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                    æˆåŠŸ: ${data.rpcStats ? data.rpcStats.successCalls : 0} | å¤±è´¥: ${data.rpcStats ? data.rpcStats.failedCalls : 0}<br>
                                    å½“å‰è¿æ¥: ${data.rpcStats ? data.rpcStats.currentConnections : 0} | å¹³å‡å“åº”: ${data.rpcStats ? data.rpcStats.avgResponseTime : 0}ms
                                </div>
                            </div>
                            
                            <div class="metric-card" id="health-status">
                                <div class="metric-title">æœåŠ¡å¥åº·çŠ¶æ€</div>
                                <div class="metric-value" style="color: #4CAF50">UP</div>
                                <div class="metric-unit">æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œ</div>
                            </div>
                            
                            <div class="metric-card">
                                <div class="metric-title">å¥åº·çŠ¶æ€</div>
                                <div class="metric-value">
                                    <span class="health-status ${data.status === 'UP' ? 'health-up' : 'health-down'}">
                                        ${data.status || 'UNKNOWN'}
                                    </span>
                                </div>
                                <div class="metric-unit">æœ€åæ£€æŸ¥: ${new Date().toLocaleTimeString()}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h3>è¯¦ç»†ä¿¡æ¯</h3>
                            <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px;">${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('è·å–å¥åº·æ•°æ®å¤±è´¥:', error);
                    document.getElementById('content').innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #e74c3c;">
                            <h3>âŒ è·å–å¥åº·æ•°æ®å¤±è´¥</h3>
                            <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                            <button onclick="loadHealthData()" style="margin-top: 20px; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">é‡è¯•</button>
                        </div>
                    `;
                });
        }
        
        // åŠ è½½é…ç½®æ•°æ®
        function loadConfigData() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <h2>âš™ï¸ é…ç½®ç®¡ç†</h2>
                <div class="loading">æ­£åœ¨åŠ è½½é…ç½®æ•°æ®...</div>
            `;
            
            // è°ƒç”¨ä¸“é—¨çš„é…ç½®APIè·å–è¯¦ç»†é…ç½®ä¿¡æ¯
            fetch('/api/management/config')
                .then(response => response.json())
                .then(data => {
                    const rpcConfig = data.rpc || {};
                    const webConfig = data.web || {};
                    const appConfig = data.application || {};
                    const instanceId = data.instanceId || 'current-instance';
                    const note = data.note || '';
                    
                    let configHtml = `
                        <h2>âš™ï¸ é…ç½®ç®¡ç†</h2>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <p>å®ä¾‹: ${instanceId} ${note ? '(' + note + ')' : ''}</p>
                            <div>
                                <button class="btn btn-sm btn-outline-success" onclick="exportConfig()">å¯¼å‡ºé…ç½®</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshConfig()">åˆ·æ–°</button>
                            </div>
                        </div>
                        
                        <!-- RPC é…ç½® -->
                        <div class="metric-card mb-3">
                            <div class="metric-title">ğŸ”— RPC æœåŠ¡é…ç½®</div>
                            <div style="font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px; border-left: 4px solid #007bff;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>rpc.provider.host:</strong> ${rpcConfig.host || 'N/A'}<br>
                                        <strong>rpc.provider.port:</strong> ${rpcConfig.port || 'N/A'}<br>
                                        <strong>rpc.provider.enabled:</strong> ${rpcConfig.enabled || 'N/A'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Web é…ç½® -->
                        <div class="metric-card mb-3">
                            <div class="metric-title">ğŸŒ Web æœåŠ¡é…ç½®</div>
                            <div style="font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px; border-left: 4px solid #28a745;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>server.port:</strong> ${webConfig.port || 'N/A'}<br>
                                        <strong>server.servlet.context-path:</strong> ${webConfig.contextPath || 'N/A'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- åº”ç”¨é…ç½® -->
                        <div class="metric-card mb-3">
                            <div class="metric-title">ğŸ“± åº”ç”¨ç¨‹åºé…ç½®</div>
                            <div style="font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px; border-left: 4px solid #ffc107;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>spring.application.name:</strong> ${appConfig.name || 'N/A'}<br>
                                        <strong>spring.profiles.active:</strong> ${Array.isArray(appConfig.profiles) ? appConfig.profiles.join(', ') : (appConfig.profiles || 'N/A')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é…ç½®ç»Ÿè®¡ -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="metric-card text-center">
                                    <div class="metric-title">RPC é…ç½®é¡¹</div>
                                    <div class="metric-value">${Object.keys(rpcConfig).length}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card text-center">
                                    <div class="metric-title">Web é…ç½®é¡¹</div>
                                    <div class="metric-value">${Object.keys(webConfig).length}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="metric-card text-center">
                                    <div class="metric-title">åº”ç”¨é…ç½®é¡¹</div>
                                    <div class="metric-value">${Object.keys(appConfig).length}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    content.innerHTML = configHtml;
                })
                .catch(error => {
                    console.error('è·å–é…ç½®ä¿¡æ¯å¤±è´¥:', error);
                    content.innerHTML = `
                        <h2>âš™ï¸ é…ç½®ç®¡ç†</h2>
                        <div class="metric-card">
                            <div class="metric-title">é…ç½®åŠ è½½å¤±è´¥</div>
                            <div style="color: red; padding: 15px;">
                                æ— æ³•è·å–é…ç½®ä¿¡æ¯: ${error.message}
                            </div>
                        </div>
                    `;
                });
        }
        
        // åˆ·æ–°é…ç½®
        function refreshConfig() {
            loadConfigData();
        }
        
        // å¯¼å‡ºé…ç½®
        function exportConfig() {
            fetch('/api/management/config')
                .then(response => response.json())
                .then(data => {
                    const configText = JSON.stringify(data, null, 2);
                    const blob = new Blob([configText], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `rpc-config-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('å¯¼å‡ºé…ç½®å¤±è´¥:', error);
                    alert('å¯¼å‡ºé…ç½®å¤±è´¥: ' + error.message);
                });
        }
        
        // åŠ è½½æ—¥å¿—æ•°æ®
        function loadLogsData() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <h2>ğŸ“‹ æ—¥å¿—æŸ¥çœ‹</h2>
                <div class="loading">æ­£åœ¨åŠ è½½æ—¥å¿—æ•°æ®...</div>
            `;
            
            // è°ƒç”¨çœŸå®çš„æ—¥å¿—APIè·å–æ—¥å¿—æ•°æ®
            fetch('/api/management/logs?lines=50&level=INFO')
                .then(response => response.json())
                .then(data => {
                    const logs = data.logs || [];
                    const total = data.total || 0;
                    const instanceId = data.instanceId || 'current-instance';
                    
                    let logsHtml = `
                        <h2>ğŸ“‹ æ—¥å¿—æŸ¥çœ‹</h2>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <p>å®ä¾‹: ${instanceId} | å…± ${total} æ¡æ—¥å¿—</p>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">åˆ·æ–°</button>
                                <select id="logLevel" class="form-select form-select-sm d-inline-block w-auto ms-2" onchange="filterLogs()">
                                    <option value="INFO">INFO</option>
                                    <option value="WARN">WARN</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="DEBUG">DEBUG</option>
                                </select>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-title">æœ€è¿‘æ—¥å¿—</div>
                            <div id="log-container" style="font-family: monospace; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; margin-top: 10px; max-height: 400px; overflow-y: auto; border: 1px solid #333;">
                    `;
                    
                    if (logs.length > 0) {
                        logs.forEach(log => {
                            const levelClass = `log-level-${log.level || 'INFO'}`;
                            const timestamp = log.timestamp || new Date().toLocaleString();
                            const message = log.message || '';
                            const thread = log.thread || 'unknown';
                            
                            logsHtml += `
                                <div class="log-line ${levelClass}" style="margin-bottom: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 4px; white-space: pre-wrap;">
                                    <span style="color: #569cd6;">[${timestamp}]</span> 
                                    <span style="color: #4ec9b0;">[${log.level || 'INFO'}]</span> 
                                    <span style="color: #9cdcfe;">[${thread}]</span> 
                                    <span>${message}</span>
                                </div>
                            `;
                        });
                    } else {
                        logsHtml += '<div style="color: #888; text-align: center; padding: 20px;">æš‚æ— æ—¥å¿—æ•°æ®</div>';
                    }
                    
                    logsHtml += `
                            </div>
                        </div>
                    `;
                    
                    content.innerHTML = logsHtml;
                })
                .catch(error => {
                    console.error('è·å–æ—¥å¿—æ•°æ®å¤±è´¥:', error);
                    content.innerHTML = `
                        <h2>ğŸ“‹ æ—¥å¿—æŸ¥çœ‹</h2>
                        <div class="metric-card">
                            <div class="metric-title">æ—¥å¿—åŠ è½½å¤±è´¥</div>
                            <div style="color: red; padding: 15px;">
                                æ— æ³•è·å–æ—¥å¿—æ•°æ®: ${error.message}
                            </div>
                        </div>
                    `;
                });
        }
        
        // åˆ·æ–°æ—¥å¿—
        function refreshLogs() {
            loadLogsData();
        }
        
        // æ ¹æ®æ—¥å¿—çº§åˆ«è¿‡æ»¤
        function filterLogs() {
            const level = document.getElementById('logLevel').value;
            const content = document.getElementById('content');
            content.innerHTML = `
                <h2>ğŸ“‹ æ—¥å¿—æŸ¥çœ‹</h2>
                <div class="loading">æ­£åœ¨åŠ è½½ ${level} çº§åˆ«æ—¥å¿—...</div>
            `;
            
            fetch(`/api/management/logs?lines=50&level=${level}`)
                .then(response => response.json())
                .then(data => {
                    const logs = data.logs || [];
                    const total = data.total || 0;
                    const instanceId = data.instanceId || 'current-instance';
                    
                    let logsHtml = `
                        <h2>ğŸ“‹ æ—¥å¿—æŸ¥çœ‹</h2>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <p>å®ä¾‹: ${instanceId} | å…± ${total} æ¡ ${level} çº§åˆ«æ—¥å¿—</p>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">åˆ·æ–°</button>
                                <select id="logLevel" class="form-select form-select-sm d-inline-block w-auto ms-2" onchange="filterLogs()">
                                    <option value="INFO" ${level === 'INFO' ? 'selected' : ''}>INFO</option>
                                    <option value="WARN" ${level === 'WARN' ? 'selected' : ''}>WARN</option>
                                    <option value="ERROR" ${level === 'ERROR' ? 'selected' : ''}>ERROR</option>
                                    <option value="DEBUG" ${level === 'DEBUG' ? 'selected' : ''}>DEBUG</option>
                                </select>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-title">${level} çº§åˆ«æ—¥å¿—</div>
                            <div id="log-container" style="font-family: monospace; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; margin-top: 10px; max-height: 400px; overflow-y: auto; border: 1px solid #333;">
                    `;
                    
                    if (logs.length > 0) {
                        logs.forEach(log => {
                            const levelClass = `log-level-${log.level || 'INFO'}`;
                            const timestamp = log.timestamp || new Date().toLocaleString();
                            const message = log.message || '';
                            const thread = log.thread || 'unknown';
                            
                            logsHtml += `
                                <div class="log-line ${levelClass}" style="margin-bottom: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 4px; white-space: pre-wrap;">
                                    <span style="color: #569cd6;">[${timestamp}]</span> 
                                    <span style="color: #4ec9b0;">[${log.level || 'INFO'}]</span> 
                                    <span style="color: #9cdcfe;">[${thread}]</span> 
                                    <span>${message}</span>
                                </div>
                            `;
                        });
                    } else {
                        logsHtml += '<div style="color: #888; text-align: center; padding: 20px;">æš‚æ— è¯¥çº§åˆ«æ—¥å¿—æ•°æ®</div>';
                    }
                    
                    logsHtml += `
                            </div>
                        </div>
                    `;
                    
                    content.innerHTML = logsHtml;
                })
                .catch(error => {
                    console.error('è¿‡æ»¤æ—¥å¿—å¤±è´¥:', error);
                    loadLogsData(); // å›é€€åˆ°é»˜è®¤æ—¥å¿—æ˜¾ç¤º
                });
        }
        
        // åŠ è½½å®ä¾‹ç®¡ç†æ•°æ®
        function loadInstancesData() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <h2>ğŸ”§ å®ä¾‹ç®¡ç†</h2>
                <div class="loading">æ­£åœ¨åŠ è½½å®ä¾‹æ•°æ®...</div>
            `;
            
            // è°ƒç”¨åç«¯APIè·å–æ‰€æœ‰å®ä¾‹æ•°æ®
            fetch('/api/management/instances')
                .then(response => response.json())
                .then(data => {
                    let instancesHtml = '<h2>ğŸ”§ å®ä¾‹ç®¡ç†</h2>';
                    
                    if (data && data.length > 0) {
                        instancesHtml += `<p>å‘ç° ${data.length} ä¸ªæœåŠ¡å®ä¾‹</p>`;
                        instancesHtml += '<div class="metrics-grid">';
                        
                        data.forEach((instance, index) => {
                            const isCurrentInstance = instance.host === window.location.hostname && 
                                                    instance.port == window.location.port;
                            const instanceTitle = isCurrentInstance ? 'å½“å‰å®ä¾‹' : `å®ä¾‹ ${index + 1}`;
                            
                            instancesHtml += `
                                <div class="metric-card" style="${isCurrentInstance ? 'border: 2px solid #4CAF50;' : ''}">
                                    <div class="metric-title">${instanceTitle}</div>
                                    <div style="margin-top: 10px; line-height: 1.6;">
                                        <strong>æœåŠ¡åœ°å€:</strong> ${instance.host}:${instance.rpcPort || 'N/A'}<br>
                                        <strong>Webç«¯å£:</strong> ${instance.port}<br>
                                        <strong>çŠ¶æ€:</strong> <span class="health-status health-up">${instance.status || 'è¿è¡Œä¸­'}</span><br>
                                        <strong>å¯åŠ¨æ—¶é—´:</strong> ${instance.startTime || 'N/A'}<br>
                                        <strong>å†…å­˜ä½¿ç”¨:</strong> ${instance.memoryUsage || 'N/A'}<br>
                                        <strong>RPCè°ƒç”¨:</strong> ${instance.rpcCalls || 'N/A'}<br>
                                        <strong>æ´»è·ƒè¿æ¥:</strong> ${instance.connections || 'N/A'}<br>
                                        <strong>æœåŠ¡æ•°é‡:</strong> ${instance.serviceCount || 'N/A'}
                                    </div>
                                </div>
                            `;
                        });
                        
                        instancesHtml += '</div>';
                    } else {
                        instancesHtml += '<p>æœªå‘ç°ä»»ä½•æœåŠ¡å®ä¾‹</p>';
                    }
                    
                    content.innerHTML = instancesHtml;
                })
                .catch(error => {
                    console.error('åŠ è½½å®ä¾‹æ•°æ®å¤±è´¥:', error);
                    content.innerHTML = `
                        <h2>ğŸ”§ å®ä¾‹ç®¡ç†</h2>
                        <div class="error">åŠ è½½å®ä¾‹æ•°æ®å¤±è´¥: ${error.message}</div>
                    `;
                });
        }
        
        // åˆ·æ–°æ•°æ®
        function refreshData() {
            fetch('/api/management/health')
                .then(response => response.json())
                .then(data => {
                    updateRealTimeData(data);
                })
                .catch(error => {
                    console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                });
        }
        
        // å®šæœŸåˆ·æ–°æ•°æ®
        setInterval(refreshData, 5000);
    </script>
</body>
</html>