# Spring Boot RPC 服务提供者多实例部署指南

## 概述

本指南说明如何在同一台机器上启动多个 Spring Boot RPC 服务提供者实例，实现负载均衡和高可用性。

## 端口分离策略

采用端口分离配置，避免Web服务和RPC服务的协议冲突：
- **Web端口范围**: 80xx (HTTP/HTTPS协议)
- **RPC端口范围**: 90xx (RPC自定义协议)
- **优势**: 协议隔离、便于监控、网络安全策略配置

## 配置文件说明

### 1. 默认配置 (application.yml)
- **RPC端口**: 9081
- **Web端口**: 8081
- **日志文件**: logs/rpc-provider.log

### 2. 实例2配置 (application-8082.yml)
- **RPC端口**: 9082
- **Web端口**: 8082
- **日志文件**: logs/rpc-provider-8082.log

### 3. 实例3配置 (application-8083.yml)
- **RPC端口**: 9083
- **Web端口**: 8083
- **日志文件**: logs/rpc-provider-8083.log

### 4. 实例4配置 (application-8084.yml)
- **RPC端口**: 9084
- **Web端口**: 8084
- **日志文件**: logs/rpc-provider-8084.log

## 启动方式

### 方式一：使用批处理脚本（推荐）

```bash
# 运行批处理脚本
start-multiple-providers.bat
```

### 方式二：手动启动各实例

```bash
# 启动实例1（默认配置）
mvn spring-boot:run -Dspring-boot.run.profiles=default

# 启动实例2
mvn spring-boot:run -Dspring-boot.run.profiles=8082

# 启动实例3
mvn spring-boot:run -Dspring-boot.run.profiles=8083

# 启动实例4
mvn spring-boot:run -Dspring-boot.run.profiles=8084
```

### 方式三：使用JAR包启动

```bash
# 先打包
mvn clean package -DskipTests

# 启动各实例
java -jar target/rpc-spring-boot-provider-sample-1.0.0.jar --spring.profiles.active=default
java -jar target/rpc-spring-boot-provider-sample-1.0.0.jar --spring.profiles.active=8082
java -jar target/rpc-spring-boot-provider-sample-1.0.0.jar --spring.profiles.active=8083
java -jar target/rpc-spring-boot-provider-sample-1.0.0.jar --spring.profiles.active=8084
```

## 服务注册与发现

所有实例都会自动注册到 Zookeeper 注册中心：
- **注册中心地址**: 192.168.109.103:2181
- **服务名称**: rpc-provider-sample
- **实例标识**: 通过不同的 host:port 区分

## 负载均衡

消费者会自动发现所有已注册的服务提供者实例，并进行负载均衡调用。RPC框架支持多种负载均衡策略。

## 监控与管理

每个实例都提供独立的管理端点：

| 实例 | RPC端口 | Web管理地址               | 健康检查 | 应用信息 |
|------|---------|-----------------------|----------|----------|
| 实例1 | 9081 | http://localhost:8081 | /actuator/health | /actuator/info |
| 实例2 | 9082 | http://localhost:8082 | /actuator/health | /actuator/info |
| 实例3 | 9083 | http://localhost:8083 | /actuator/health | /actuator/info |
| 实例4 | 9084 | http://localhost:8084 | /actuator/health | /actuator/info |

## 日志管理

每个实例使用独立的日志文件，避免日志冲突：
- 实例1: `logs/rpc-provider.log`
- 实例2: `logs/rpc-provider-8082.log`
- 实例3: `logs/rpc-provider-8083.log`
- 实例4: `logs/rpc-provider-8084.log`

## 注意事项

1. **端口冲突**: 确保每个实例使用不同的RPC端口和Web端口
2. **端口分离**: Web端口(80xx)和RPC端口(90xx)分离，避免协议冲突
3. **注册中心**: 确保Zookeeper服务正常运行
4. **资源消耗**: 多实例会增加内存和CPU使用量
5. **日志空间**: 注意磁盘空间，定期清理日志文件
6. **配置一致性**: 除端口外，其他配置应保持一致

## 扩展更多实例

如需添加更多实例，按以下步骤操作：

1. 复制现有配置文件（如 application-8085.yml）
2. 修改端口配置（遵循端口分离策略）：
   ```yaml
   server:
     port: 8085  # Web端口 (80xx系列)
   rpc:
     provider:
       port: 9085  # RPC端口 (90xx系列)
   logging:
     file:
       name: logs/rpc-provider-8085.log  # 日志文件
   ```
3. 更新启动脚本或手动启动新实例

## 停止服务

- 使用 `Ctrl+C` 停止单个实例
- 或通过管理端点优雅关闭：`POST /actuator/shutdown`