<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿæ¦‚è§ˆ - RPC Consumer</title>
    <link rel="stylesheet" href="/css/management.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h1>
            <p>RPC Consumer æœåŠ¡ç›‘æ§é¢æ¿</p>
        </div>
        
        <div class="nav">
            <a href="/" class="nav-btn">ğŸ  é¦–é¡µ</a>
            <a href="/management/overview" class="nav-btn active">ğŸ“Š æ¦‚è§ˆ</a>
            <a href="/management/discovery" class="nav-btn">ğŸ” æœåŠ¡å‘ç°</a>
            <a href="/management/health" class="nav-btn">ğŸ’š å¥åº·æ£€æŸ¥</a>
            <a href="/management/metrics" class="nav-btn">ğŸ“ˆ æŒ‡æ ‡ç›‘æ§</a>
        </div>
        
        <div class="content">
            <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">ğŸŒ å¯ç”¨æœåŠ¡æ•°</div>
                    <div class="metric-value" id="serviceCount">-</div>
                    <div class="metric-change">å®æ—¶æ›´æ–°</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">ğŸ”— æ´»è·ƒè¿æ¥æ•°</div>
                    <div class="metric-value" id="connectionCount">-</div>
                    <div class="metric-change">å½“å‰è¿æ¥</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">ğŸ“ æ€»è°ƒç”¨æ¬¡æ•°</div>
                    <div class="metric-value" id="totalCalls">-</div>
                    <div class="metric-change">ç´¯è®¡ç»Ÿè®¡</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">âš¡ å¹³å‡å“åº”æ—¶é—´</div>
                    <div class="metric-value" id="avgResponseTime">-</div>
                    <div class="metric-change">æ¯«ç§’</div>
                </div>
            </div>
            
            <!-- æœåŠ¡å®ä¾‹çŠ¶æ€ -->
            <div class="section">
                <h3>ğŸ¢ æœåŠ¡å®ä¾‹çŠ¶æ€</h3>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="refreshInstances()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                    <button class="btn btn-success" onclick="testAllInstances()">ğŸ§ª æµ‹è¯•æ‰€æœ‰å®ä¾‹</button>
                </div>
                <div id="instancesContainer" class="service-instances fade-in">
                    <!-- æœåŠ¡å®ä¾‹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            
            <!-- æœ€è¿‘è°ƒç”¨å†å² -->
            <div class="section">
                <h3>ğŸ“‹ æœ€è¿‘è°ƒç”¨å†å²</h3>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="refreshCallHistory()">ğŸ”„ åˆ·æ–°å†å²</button>
                    <button class="btn btn-warning" onclick="clearCallHistory()">ğŸ—‘ï¸ æ¸…ç©ºå†å²</button>
                </div>
                <div id="callHistoryContainer" class="call-history">
                    <!-- è°ƒç”¨å†å²å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            
            <!-- ç³»ç»Ÿä¿¡æ¯ -->
            <div class="section">
                <h3>ğŸ’» ç³»ç»Ÿä¿¡æ¯</h3>
                <div class="config-table-container">
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th>é…ç½®é¡¹</th>
                                <th>å½“å‰å€¼</th>
                                <th>è¯´æ˜</th>
                            </tr>
                        </thead>
                        <tbody id="systemInfoTable">
                            <!-- ç³»ç»Ÿä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- å†…å­˜ä½¿ç”¨æƒ…å†µ -->
            <div class="section">
                <h3>ğŸ§  å†…å­˜ä½¿ç”¨æƒ…å†µ</h3>
                <div class="memory-usage">
                    <div class="memory-bar">
                        <div class="memory-used" id="memoryUsed" style="width: 0%;">å·²ä½¿ç”¨: 0MB</div>
                        <div class="memory-free" id="memoryFree" style="width: 100%;">å¯ç”¨: 0MB</div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        <span>æ€»å†…å­˜: <span id="totalMemory">0MB</span></span>
                        <span style="margin-left: 20px;">ä½¿ç”¨ç‡: <span id="memoryUsage">0%</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            refreshOverview();
            refreshInstances();
            refreshCallHistory();
            loadSystemInfo();
            updateMemoryUsage();
            
            // è®¾ç½®å®šæ—¶åˆ·æ–°
            setInterval(refreshOverview, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡æ¦‚è§ˆæ•°æ®
            setInterval(updateMemoryUsage, 10000); // 10ç§’åˆ·æ–°ä¸€æ¬¡å†…å­˜ä½¿ç”¨æƒ…å†µ
        });
        
        // åˆ·æ–°æ¦‚è§ˆæ•°æ®
        function refreshOverview() {
            fetch('/api/management/overview')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('serviceCount').textContent = data.serviceCount || 0;
                    document.getElementById('connectionCount').textContent = data.connectionCount || 0;
                    document.getElementById('totalCalls').textContent = data.totalCalls || 0;
                    document.getElementById('avgResponseTime').textContent = (data.avgResponseTime || 0) + 'ms';
                })
                .catch(error => {
                    console.error('è·å–æ¦‚è§ˆæ•°æ®å¤±è´¥:', error);
                });
        }
        
        // åˆ·æ–°æœåŠ¡å®ä¾‹
        function refreshInstances() {
            fetch('/api/management/instances')
                .then(response => response.json())
                .then(instances => {
                    displayInstances(instances);
                })
                .catch(error => {
                    console.error('è·å–å®ä¾‹åˆ—è¡¨å¤±è´¥:', error);
                    document.getElementById('instancesContainer').innerHTML = 
                        '<div class="alert alert-danger">âŒ è·å–å®ä¾‹åˆ—è¡¨å¤±è´¥: ' + error.message + '</div>';
                });
        }
        
        // æ˜¾ç¤ºæœåŠ¡å®ä¾‹
        function displayInstances(instances) {
            const container = document.getElementById('instancesContainer');
            
            if (instances.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">âš ï¸ æš‚æ— å¯ç”¨æœåŠ¡å®ä¾‹</div>';
                return;
            }
            
            let html = '';
            instances.forEach(instance => {
                const statusClass = instance.healthy ? 'healthy' : 'unhealthy';
                const statusIcon = instance.healthy ? 'âœ…' : 'âŒ';
                
                html += `
                    <div class="instance-card">
                        <div class="instance-status ${statusClass}">${statusIcon} ${instance.healthy ? 'HEALTHY' : 'UNHEALTHY'}</div>
                        <div class="instance-address">${instance.address}:${instance.port}</div>
                        <div class="instance-meta">
                            <div>ğŸ·ï¸ æœåŠ¡: ${instance.serviceName}</div>
                            <div>â° æ³¨å†Œæ—¶é—´: ${new Date(instance.registerTime).toLocaleString()}</div>
                            <div>ğŸ“Š æƒé‡: ${instance.weight || 1}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // æµ‹è¯•æ‰€æœ‰å®ä¾‹
        function testAllInstances() {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div> æµ‹è¯•ä¸­...';
            
            fetch('/api/management/test-instances', { method: 'POST' })
                .then(response => response.json())
                .then(result => {
                    alert(`æµ‹è¯•å®Œæˆï¼\nå¥åº·å®ä¾‹: ${result.healthy}\nå¼‚å¸¸å®ä¾‹: ${result.unhealthy}`);
                    refreshInstances();
                })
                .catch(error => {
                    alert('æµ‹è¯•å¤±è´¥: ' + error.message);
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = 'ğŸ§ª æµ‹è¯•æ‰€æœ‰å®ä¾‹';
                });
        }
        
        // åˆ·æ–°è°ƒç”¨å†å²
        function refreshCallHistory() {
            fetch('/api/management/call-history')
                .then(response => response.json())
                .then(history => {
                    displayCallHistory(history);
                })
                .catch(error => {
                    console.error('è·å–è°ƒç”¨å†å²å¤±è´¥:', error);
                    document.getElementById('callHistoryContainer').innerHTML = 
                        '<div class="alert alert-danger">âŒ è·å–è°ƒç”¨å†å²å¤±è´¥: ' + error.message + '</div>';
                });
        }
        
        // æ˜¾ç¤ºè°ƒç”¨å†å²
        function displayCallHistory(history) {
            const container = document.getElementById('callHistoryContainer');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="alert alert-info">ğŸ“ æš‚æ— è°ƒç”¨å†å²è®°å½•</div>';
                return;
            }
            
            let html = '';
            history.forEach(call => {
                const statusClass = call.success ? 'success' : 'error';
                const statusIcon = call.success ? 'âœ…' : 'âŒ';
                
                html += `
                    <div class="call-item">
                        <div>
                            <div class="call-method">${call.serviceName}.${call.methodName}</div>
                            <div class="call-time">${new Date(call.timestamp).toLocaleString()}</div>
                        </div>
                        <div>
                            <div class="call-status ${statusClass}">${statusIcon} ${call.success ? 'SUCCESS' : 'ERROR'}</div>
                            <div class="call-duration">${call.duration}ms</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // æ¸…ç©ºè°ƒç”¨å†å²
        function clearCallHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè°ƒç”¨å†å²å—ï¼Ÿ')) {
                fetch('/api/management/call-history', { method: 'DELETE' })
                    .then(() => {
                        refreshCallHistory();
                        alert('è°ƒç”¨å†å²å·²æ¸…ç©º');
                    })
                    .catch(error => {
                        alert('æ¸…ç©ºå¤±è´¥: ' + error.message);
                    });
            }
        }
        
        // åŠ è½½ç³»ç»Ÿä¿¡æ¯
        function loadSystemInfo() {
            const systemInfo = [
                { key: 'åº”ç”¨åç§°', value: 'RPC Consumer Sample', desc: 'å½“å‰åº”ç”¨æ ‡è¯†' },
                { key: 'æœåŠ¡ç«¯å£', value: '8071', desc: 'HTTPæœåŠ¡ç›‘å¬ç«¯å£' },
                { key: 'æ³¨å†Œä¸­å¿ƒ', value: 'ZooKeeper', desc: 'æœåŠ¡å‘ç°ç»„ä»¶' },
                { key: 'æ³¨å†Œä¸­å¿ƒåœ°å€', value: 'localhost:2181', desc: 'ZooKeeperè¿æ¥åœ°å€' },
                { key: 'è¿æ¥è¶…æ—¶', value: '5000ms', desc: 'RPCè°ƒç”¨è¶…æ—¶æ—¶é—´' },
                { key: 'é‡è¯•æ¬¡æ•°', value: '3', desc: 'è°ƒç”¨å¤±è´¥é‡è¯•æ¬¡æ•°' },
                { key: 'è¿æ¥æ± å¤§å°', value: '10', desc: 'æœ€å¤§è¿æ¥æ± å¤§å°' },
                { key: 'Javaç‰ˆæœ¬', value: getJavaVersion(), desc: 'JVMè¿è¡Œæ—¶ç‰ˆæœ¬' }
            ];
            
            const tbody = document.getElementById('systemInfoTable');
            let html = '';
            systemInfo.forEach(info => {
                html += `
                    <tr>
                        <td>${info.key}</td>
                        <td><span class="config-value">${info.value}</span></td>
                        <td>${info.desc}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }
        
        // è·å–Javaç‰ˆæœ¬ï¼ˆæ¨¡æ‹Ÿï¼‰
        function getJavaVersion() {
            return navigator.userAgent.includes('Java') ? 'Java 11+' : 'Java 8+';
        }
        
        // æ›´æ–°å†…å­˜ä½¿ç”¨æƒ…å†µ
        function updateMemoryUsage() {
            // æ¨¡æ‹Ÿå†…å­˜ä½¿ç”¨æ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä»åç«¯APIè·å–ï¼‰
            const totalMemory = 512; // MB
            const usedMemory = Math.floor(Math.random() * 300) + 100; // 100-400MB
            const freeMemory = totalMemory - usedMemory;
            const usagePercent = Math.round((usedMemory / totalMemory) * 100);
            
            document.getElementById('memoryUsed').style.width = usagePercent + '%';
            document.getElementById('memoryUsed').textContent = `å·²ä½¿ç”¨: ${usedMemory}MB`;
            document.getElementById('memoryFree').style.width = (100 - usagePercent) + '%';
            document.getElementById('memoryFree').textContent = `å¯ç”¨: ${freeMemory}MB`;
            document.getElementById('totalMemory').textContent = totalMemory + 'MB';
            document.getElementById('memoryUsage').textContent = usagePercent + '%';
        }
    </script>
</body>
</html>