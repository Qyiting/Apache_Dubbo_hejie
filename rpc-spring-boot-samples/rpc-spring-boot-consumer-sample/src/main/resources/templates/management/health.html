<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健康检查 - RPC Consumer</title>
    <link rel="stylesheet" href="/css/management.css">
    <style>
        .health-status {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }
        
        .health-status.healthy {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        
        .health-status.unhealthy {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
            color: white;
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }
        
        .health-status.warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: #212529;
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
        }
        
        .health-icon {
            font-size: 48px;
            margin-right: 20px;
        }
        
        .health-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .health-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .health-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .health-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .health-card-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .health-card-title {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
        }
        
        .health-card-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: auto;
        }
        
        .health-card-content {
            color: #666;
            line-height: 1.6;
        }
        
        .health-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .health-metric:last-child {
            border-bottom: none;
        }
        
        .health-metric-label {
            font-weight: 500;
            color: #495057;
        }
        
        .health-metric-value {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .health-test-results {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .test-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-result-item:last-child {
            border-bottom: none;
        }
        
        .test-result-info {
            flex: 1;
        }
        
        .test-result-name {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .test-result-desc {
            font-size: 12px;
            color: #666;
        }
        
        .test-result-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-result-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .test-result-time {
            font-size: 11px;
            color: #666;
        }
        
        .progress-ring {
            width: 60px;
            height: 60px;
            margin: 0 auto;
        }
        
        .progress-ring-circle {
            stroke: #e9ecef;
            stroke-width: 4;
            fill: transparent;
            r: 26;
            cx: 30;
            cy: 30;
        }
        
        .progress-ring-progress {
            stroke: #28a745;
            stroke-width: 4;
            fill: transparent;
            r: 26;
            cx: 30;
            cy: 30;
            stroke-dasharray: 163.36;
            stroke-dashoffset: 163.36;
            transform: rotate(-90deg);
            transform-origin: 30px 30px;
            transition: stroke-dashoffset 0.5s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💚 健康检查</h1>
            <p>系统和服务健康状态监控</p>
        </div>
        
        <div class="nav">
            <a href="/" class="nav-btn">🏠 首页</a>
            <a href="/management/overview" class="nav-btn">📊 概览</a>
            <a href="/management/discovery" class="nav-btn">🔍 服务发现</a>
            <a href="/management/health" class="nav-btn active">💚 健康检查</a>
            <a href="/management/metrics" class="nav-btn">📈 指标监控</a>
        </div>
        
        <div class="content">
            <!-- 整体健康状态 -->
            <div id="overallHealth" class="health-status healthy">
                <div class="health-icon">💚</div>
                <div>
                    <div>系统运行正常</div>
                    <div style="font-size: 14px; font-weight: normal; margin-top: 5px;">所有组件状态良好</div>
                </div>
            </div>
            
            <!-- 操作按钮 -->
            <div class="btn-group">
                <button class="btn btn-primary" onclick="runHealthCheck()">🔍 执行健康检查</button>
                <button class="btn btn-success" onclick="runFullDiagnostic()">🧪 完整诊断</button>
                <button class="btn btn-secondary" onclick="refreshHealth()">🔄 刷新状态</button>
                <button class="btn btn-warning" onclick="exportHealthReport()">📄 导出报告</button>
            </div>
            
            <!-- 健康检查详情 -->
            <div class="health-details" id="healthDetails">
                <!-- 健康检查卡片将通过JavaScript动态生成 -->
            </div>
            
            <!-- 健康检查测试结果 -->
            <div class="section">
                <h3>🧪 检查结果</h3>
                <div id="testResults" class="health-test-results">
                    <div class="alert alert-info">点击上方按钮开始健康检查</div>
                </div>
            </div>
            
            <!-- 系统资源监控 -->
            <div class="section">
                <h3>📊 系统资源</h3>
                <div class="health-details">
                    <div class="health-card">
                        <div class="health-card-header">
                            <div class="health-card-icon">🧠</div>
                            <div class="health-card-title">内存使用</div>
                        </div>
                        <div class="health-card-content">
                            <svg class="progress-ring">
                                <circle class="progress-ring-circle"></circle>
                                <circle class="progress-ring-progress" id="memoryProgress"></circle>
                            </svg>
                            <div class="progress-text" id="memoryText">0%</div>
                            <div class="health-metric">
                                <span class="health-metric-label">已使用</span>
                                <span class="health-metric-value" id="memoryUsed">0 MB</span>
                            </div>
                            <div class="health-metric">
                                <span class="health-metric-label">总内存</span>
                                <span class="health-metric-value" id="memoryTotal">0 MB</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-card-header">
                            <div class="health-card-icon">⚡</div>
                            <div class="health-card-title">CPU使用</div>
                        </div>
                        <div class="health-card-content">
                            <svg class="progress-ring">
                                <circle class="progress-ring-circle"></circle>
                                <circle class="progress-ring-progress" id="cpuProgress"></circle>
                            </svg>
                            <div class="progress-text" id="cpuText">0%</div>
                            <div class="health-metric">
                                <span class="health-metric-label">当前负载</span>
                                <span class="health-metric-value" id="cpuLoad">0%</span>
                            </div>
                            <div class="health-metric">
                                <span class="health-metric-label">平均负载</span>
                                <span class="health-metric-value" id="cpuAvg">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-card-header">
                            <div class="health-card-icon">🌐</div>
                            <div class="health-card-title">网络连接</div>
                        </div>
                        <div class="health-card-content">
                            <div class="health-metric">
                                <span class="health-metric-label">活跃连接</span>
                                <span class="health-metric-value" id="activeConnections">0</span>
                            </div>
                            <div class="health-metric">
                                <span class="health-metric-label">总连接数</span>
                                <span class="health-metric-value" id="totalConnections">0</span>
                            </div>
                            <div class="health-metric">
                                <span class="health-metric-label">网络延迟</span>
                                <span class="health-metric-value" id="networkLatency">0ms</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let healthCheckInterval;
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            refreshHealth();
            updateSystemResources();
            
            // 设置定时刷新
            healthCheckInterval = setInterval(() => {
                refreshHealth();
                updateSystemResources();
            }, 30000); // 30秒刷新一次
        });
        
        // 刷新健康状态
        function refreshHealth() {
            fetch('/api/management/health')
                .then(response => response.json())
                .then(health => {
                    updateOverallHealth(health);
                    updateHealthDetails(health);
                })
                .catch(error => {
                    console.error('获取健康状态失败:', error);
                    updateOverallHealth({ status: 'DOWN', error: error.message });
                });
        }
        
        // 更新整体健康状态
        function updateOverallHealth(health) {
            const overallHealth = document.getElementById('overallHealth');
            const isHealthy = health.status === 'UP';
            
            overallHealth.className = `health-status ${isHealthy ? 'healthy' : 'unhealthy'}`;
            overallHealth.innerHTML = `
                <div class="health-icon">${isHealthy ? '💚' : '❤️'}</div>
                <div>
                    <div>${isHealthy ? '系统运行正常' : '系统异常'}</div>
                    <div style="font-size: 14px; font-weight: normal; margin-top: 5px;">
                        ${isHealthy ? '所有组件状态良好' : (health.error || '部分组件异常')}
                    </div>
                </div>
            `;
        }
        
        // 更新健康检查详情
        function updateHealthDetails(health) {
            const container = document.getElementById('healthDetails');
            
            const components = [
                {
                    name: 'RPC框架',
                    icon: '🔗',
                    status: health.rpc?.status || 'UP',
                    details: health.rpc?.details || '连接正常'
                },
                {
                    name: 'ZooKeeper',
                    icon: '🐘',
                    status: health.zookeeper?.status || 'UP',
                    details: health.zookeeper?.details || '注册中心连接正常'
                },
                {
                    name: '数据库',
                    icon: '🗄️',
                    status: health.database?.status || 'UP',
                    details: health.database?.details || '数据库连接正常'
                },
                {
                    name: '磁盘空间',
                    icon: '💾',
                    status: health.disk?.status || 'UP',
                    details: health.disk?.details || '磁盘空间充足'
                }
            ];
            
            let html = '';
            components.forEach(component => {
                const isHealthy = component.status === 'UP';
                const statusClass = isHealthy ? 'healthy' : 'unhealthy';
                const statusText = isHealthy ? 'HEALTHY' : 'UNHEALTHY';
                
                html += `
                    <div class="health-card fade-in">
                        <div class="health-card-header">
                            <div class="health-card-icon">${component.icon}</div>
                            <div class="health-card-title">${component.name}</div>
                            <div class="health-card-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="health-card-content">
                            <p>${component.details}</p>
                            <div class="health-metric">
                                <span class="health-metric-label">状态</span>
                                <span class="health-metric-value">${component.status}</span>
                            </div>
                            <div class="health-metric">
                                <span class="health-metric-label">检查时间</span>
                                <span class="health-metric-value">${new Date().toLocaleTimeString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 执行健康检查
        function runHealthCheck() {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div> 检查中...';
            
            fetch('/api/management/health-check', { method: 'POST' })
                .then(response => response.json())
                .then(results => {
                    displayTestResults(results);
                    refreshHealth();
                })
                .catch(error => {
                    displayTestResults([{
                        name: '健康检查',
                        status: 'FAILED',
                        message: error.message,
                        timestamp: new Date().toISOString()
                    }]);
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = '🔍 执行健康检查';
                });
        }
        
        // 执行完整诊断
        function runFullDiagnostic() {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div> 诊断中...';
            
            fetch('/api/management/diagnostic', { method: 'POST' })
                .then(response => response.json())
                .then(results => {
                    displayTestResults(results);
                    refreshHealth();
                })
                .catch(error => {
                    displayTestResults([{
                        name: '完整诊断',
                        status: 'FAILED',
                        message: error.message,
                        timestamp: new Date().toISOString()
                    }]);
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = '🧪 完整诊断';
                });
        }
        
        // 显示测试结果
        function displayTestResults(results) {
            const container = document.getElementById('testResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="alert alert-info">暂无测试结果</div>';
                return;
            }
            
            let html = '';
            results.forEach(result => {
                const isSuccess = result.status === 'PASSED' || result.status === 'UP';
                const statusClass = isSuccess ? 'success' : 'error';
                const statusIcon = isSuccess ? '✅' : '❌';
                
                html += `
                    <div class="test-result-item">
                        <div class="test-result-info">
                            <div class="test-result-name">${result.name}</div>
                            <div class="test-result-desc">${result.message || result.details || '无详细信息'}</div>
                        </div>
                        <div class="test-result-status">
                            <div class="test-result-badge ${statusClass}">${statusIcon} ${result.status}</div>
                            <div class="test-result-time">${new Date(result.timestamp).toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 导出健康报告
        function exportHealthReport() {
            fetch('/api/management/health-report')
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `health-report-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    alert('导出失败: ' + error.message);
                });
        }
        
        // 更新系统资源
        function updateSystemResources() {
            // 模拟系统资源数据
            const memoryUsage = Math.floor(Math.random() * 60) + 20; // 20-80%
            const cpuUsage = Math.floor(Math.random() * 40) + 10; // 10-50%
            
            updateProgressRing('memoryProgress', memoryUsage);
            document.getElementById('memoryText').textContent = memoryUsage + '%';
            document.getElementById('memoryUsed').textContent = Math.floor(512 * memoryUsage / 100) + ' MB';
            document.getElementById('memoryTotal').textContent = '512 MB';
            
            updateProgressRing('cpuProgress', cpuUsage);
            document.getElementById('cpuText').textContent = cpuUsage + '%';
            document.getElementById('cpuLoad').textContent = cpuUsage + '%';
            document.getElementById('cpuAvg').textContent = Math.floor(cpuUsage * 0.8) + '%';
            
            document.getElementById('activeConnections').textContent = Math.floor(Math.random() * 20) + 5;
            document.getElementById('totalConnections').textContent = Math.floor(Math.random() * 100) + 50;
            document.getElementById('networkLatency').textContent = Math.floor(Math.random() * 50) + 10 + 'ms';
        }
        
        // 更新进度环
        function updateProgressRing(elementId, percentage) {
            const circle = document.getElementById(elementId);
            const circumference = 2 * Math.PI * 26;
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            // 根据百分比改变颜色
            if (percentage < 50) {
                circle.style.stroke = '#28a745';
            } else if (percentage < 80) {
                circle.style.stroke = '#ffc107';
            } else {
                circle.style.stroke = '#dc3545';
            }
        }
        
        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', function() {
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
            }
        });
    </script>
</body>
</html>