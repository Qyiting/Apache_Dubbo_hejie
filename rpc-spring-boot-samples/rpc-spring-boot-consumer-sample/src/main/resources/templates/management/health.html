<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥åº·æ£€æŸ¥ - RPC Consumer</title>
    <link rel="stylesheet" href="/css/management.css">
    <style>
        .health-status {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }
        
        .health-status.healthy {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        
        .health-status.unhealthy {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
            color: white;
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }
        
        .health-status.warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: #212529;
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
        }
        
        .health-icon {
            font-size: 48px;
            margin-right: 20px;
        }
        
        .health-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .health-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .health-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .health-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .health-card-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .health-card-title {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
        }
        
        .health-card-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: auto;
        }
        
        .health-card-content {
            color: #666;
            line-height: 1.6;
        }
        
        .health-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .health-metric:last-child {
            border-bottom: none;
        }
        
        .health-metric-label {
            font-weight: 500;
            color: #495057;
        }
        
        .health-metric-value {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .health-test-results {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .test-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-result-item:last-child {
            border-bottom: none;
        }
        
        .test-result-info {
            flex: 1;
        }
        
        .test-result-name {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .test-result-desc {
            font-size: 12px;
            color: #666;
        }
        
        .test-result-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-result-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .test-result-time {
            font-size: 11px;
            color: #666;
        }
        
        .progress-ring {
            width: 60px;
            height: 60px;
            margin: 0 auto;
        }
        
        .progress-ring-circle {
            stroke: #e9ecef;
            stroke-width: 4;
            fill: transparent;
            r: 26;
            cx: 30;
            cy: 30;
        }
        
        .progress-ring-progress {
            stroke: #28a745;
            stroke-width: 4;
            fill: transparent;
            r: 26;
            cx: 30;
            cy: 30;
            stroke-dasharray: 163.36;
            stroke-dashoffset: 163.36;
            transform: rotate(-90deg);
            transform-origin: 30px 30px;
            transition: stroke-dashoffset 0.5s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’š å¥åº·æ£€æŸ¥</h1>
            <p>ç³»ç»Ÿå’ŒæœåŠ¡å¥åº·çŠ¶æ€ç›‘æ§</p>
        </div>
        
        <div class="nav">
            <a href="/" class="nav-btn">ğŸ  é¦–é¡µ</a>
            <a href="/management/overview" class="nav-btn">ğŸ“Š æ¦‚è§ˆ</a>
            <a href="/management/discovery" class="nav-btn">ğŸ” æœåŠ¡å‘ç°</a>
            <a href="/management/health" class="nav-btn active">ğŸ’š å¥åº·æ£€æŸ¥</a>
            <a href="/management/metrics" class="nav-btn">ğŸ“ˆ æŒ‡æ ‡ç›‘æ§</a>
        </div>
        
        <div class="content">
            <!-- æ•´ä½“å¥åº·çŠ¶æ€ -->
            <div id="overallHealth" class="health-status healthy">
                <div class="health-icon">ğŸ’š</div>
                <div>
                    <div>ç³»ç»Ÿè¿è¡Œæ­£å¸¸</div>
                    <div style="font-size: 14px; font-weight: normal; margin-top: 5px;">æ‰€æœ‰ç»„ä»¶çŠ¶æ€è‰¯å¥½</div>
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="btn-group">
                <button class="btn btn-primary" onclick="runHealthCheck()">ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥</button>
                <button class="btn btn-success" onclick="runFullDiagnostic()">ğŸ§ª å®Œæ•´è¯Šæ–­</button>
                <button class="btn btn-secondary" onclick="refreshHealth()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                <button class="btn btn-warning" onclick="exportHealthReport()">ğŸ“„ å¯¼å‡ºæŠ¥å‘Š</button>
            </div>
            
            <!-- å¥åº·æ£€æŸ¥è¯¦æƒ… -->
            <div class="health-details" id="healthDetails">
                <!-- å¥åº·æ£€æŸ¥å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- å¥åº·æ£€æŸ¥æµ‹è¯•ç»“æœ -->
            <div class="section">
                <h3>ğŸ§ª æ£€æŸ¥ç»“æœ</h3>
                <div id="testResults" class="health-test-results">
                    <div class="alert alert-info">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹å¥åº·æ£€æŸ¥</div>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿèµ„æºç›‘æ§ -->
            <div class="section">
                <h3>ğŸ“Š ç³»ç»Ÿèµ„æº</h3>
                <div class="health-details">
                    <div class="health-card">
                        <div class="health-card-header">
                            <div class="health-card-icon">ğŸ§ </div>
                            <div class="health-card-title">å†…å­˜ä½¿ç”¨</div>
                        </div>
                        <div class="health-card-content">
                            <svg class="progress-ring">
                                <circle class="progress-ring-circle"></circle>
                                <circle class="progress-ring-progress" id="memoryProgress"></circle>
                            </svg>
                            <div class="progress-text" id="memoryText">0%</div>
                            <div class="health-metric">
                                <span class="health-metric-label">å·²ä½¿ç”¨</span>
                                <span class="health-metric-value" id="memoryUsed">0 MB</span>
                            </div>
                            <div class="health-metric">
                                <span class="health-metric-label">æ€»å†…å­˜</span>
                                <span class="health-metric-value" id="memoryTotal">0 MB</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-card-header">
                            <div class="health-card-icon">âš¡</div>
                            <div class="health-card-title">CPUä½¿ç”¨</div>
                        </div>
                        <div class="health-card-content">
                            <svg class="progress-ring">
                                <circle class="progress-ring-circle"></circle>
                                <circle class="progress-ring-progress" id="cpuProgress"></circle>
                            </svg>
                            <div class="progress-text" id="cpuText">0%</div>
                            <div class="health-metric">
                                <span class="health-metric-label">å½“å‰è´Ÿè½½</span>
                                <span class="health-metric-value" id="cpuLoad">0%</span>
                            </div>
                            <div class="health-metric">
                                <span class="health-metric-label">å¹³å‡è´Ÿè½½</span>
                                <span class="health-metric-value" id="cpuAvg">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="health-card">
                        <div class="health-card-header">
                            <div class="health-card-icon">ğŸŒ</div>
                            <div class="health-card-title">ç½‘ç»œè¿æ¥</div>
                        </div>
                        <div class="health-card-content">
                            <div class="health-metric">
                                <span class="health-metric-label">æ´»è·ƒè¿æ¥</span>
                                <span class="health-metric-value" id="activeConnections">0</span>
                            </div>
                            <div class="health-metric">
                                <span class="health-metric-label">æ€»è¿æ¥æ•°</span>
                                <span class="health-metric-value" id="totalConnections">0</span>
                            </div>
                            <div class="health-metric">
                                <span class="health-metric-label">ç½‘ç»œå»¶è¿Ÿ</span>
                                <span class="health-metric-value" id="networkLatency">0ms</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let healthCheckInterval;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshHealth();
            updateSystemResources();
            
            // è®¾ç½®å®šæ—¶åˆ·æ–°
            healthCheckInterval = setInterval(() => {
                refreshHealth();
                updateSystemResources();
            }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
        });
        
        // åˆ·æ–°å¥åº·çŠ¶æ€
        function refreshHealth() {
            fetch('/api/management/health')
                .then(response => response.json())
                .then(health => {
                    updateOverallHealth(health);
                    updateHealthDetails(health);
                })
                .catch(error => {
                    console.error('è·å–å¥åº·çŠ¶æ€å¤±è´¥:', error);
                    updateOverallHealth({ status: 'DOWN', error: error.message });
                });
        }
        
        // æ›´æ–°æ•´ä½“å¥åº·çŠ¶æ€
        function updateOverallHealth(health) {
            const overallHealth = document.getElementById('overallHealth');
            const isHealthy = health.status === 'UP';
            
            overallHealth.className = `health-status ${isHealthy ? 'healthy' : 'unhealthy'}`;
            overallHealth.innerHTML = `
                <div class="health-icon">${isHealthy ? 'ğŸ’š' : 'â¤ï¸'}</div>
                <div>
                    <div>${isHealthy ? 'ç³»ç»Ÿè¿è¡Œæ­£å¸¸' : 'ç³»ç»Ÿå¼‚å¸¸'}</div>
                    <div style="font-size: 14px; font-weight: normal; margin-top: 5px;">
                        ${isHealthy ? 'æ‰€æœ‰ç»„ä»¶çŠ¶æ€è‰¯å¥½' : (health.error || 'éƒ¨åˆ†ç»„ä»¶å¼‚å¸¸')}
                    </div>
                </div>
            `;
        }
        
        // æ›´æ–°å¥åº·æ£€æŸ¥è¯¦æƒ…
        function updateHealthDetails(health) {
            const container = document.getElementById('healthDetails');
            
            const components = [
                {
                    name: 'RPCæ¡†æ¶',
                    icon: 'ğŸ”—',
                    status: health.rpc?.status || 'UP',
                    details: health.rpc?.details || 'è¿æ¥æ­£å¸¸'
                },
                {
                    name: 'ZooKeeper',
                    icon: 'ğŸ˜',
                    status: health.zookeeper?.status || 'UP',
                    details: health.zookeeper?.details || 'æ³¨å†Œä¸­å¿ƒè¿æ¥æ­£å¸¸'
                },
                {
                    name: 'æ•°æ®åº“',
                    icon: 'ğŸ—„ï¸',
                    status: health.database?.status || 'UP',
                    details: health.database?.details || 'æ•°æ®åº“è¿æ¥æ­£å¸¸'
                },
                {
                    name: 'ç£ç›˜ç©ºé—´',
                    icon: 'ğŸ’¾',
                    status: health.disk?.status || 'UP',
                    details: health.disk?.details || 'ç£ç›˜ç©ºé—´å……è¶³'
                }
            ];
            
            let html = '';
            components.forEach(component => {
                const isHealthy = component.status === 'UP';
                const statusClass = isHealthy ? 'healthy' : 'unhealthy';
                const statusText = isHealthy ? 'HEALTHY' : 'UNHEALTHY';
                
                html += `
                    <div class="health-card fade-in">
                        <div class="health-card-header">
                            <div class="health-card-icon">${component.icon}</div>
                            <div class="health-card-title">${component.name}</div>
                            <div class="health-card-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="health-card-content">
                            <p>${component.details}</p>
                            <div class="health-metric">
                                <span class="health-metric-label">çŠ¶æ€</span>
                                <span class="health-metric-value">${component.status}</span>
                            </div>
                            <div class="health-metric">
                                <span class="health-metric-label">æ£€æŸ¥æ—¶é—´</span>
                                <span class="health-metric-value">${new Date().toLocaleTimeString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // æ‰§è¡Œå¥åº·æ£€æŸ¥
        function runHealthCheck() {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div> æ£€æŸ¥ä¸­...';
            
            fetch('/api/management/health-check', { method: 'POST' })
                .then(response => response.json())
                .then(results => {
                    displayTestResults(results);
                    refreshHealth();
                })
                .catch(error => {
                    displayTestResults([{
                        name: 'å¥åº·æ£€æŸ¥',
                        status: 'FAILED',
                        message: error.message,
                        timestamp: new Date().toISOString()
                    }]);
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = 'ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥';
                });
        }
        
        // æ‰§è¡Œå®Œæ•´è¯Šæ–­
        function runFullDiagnostic() {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = '<div class="loading-spinner"></div> è¯Šæ–­ä¸­...';
            
            fetch('/api/management/diagnostic', { method: 'POST' })
                .then(response => response.json())
                .then(results => {
                    displayTestResults(results);
                    refreshHealth();
                })
                .catch(error => {
                    displayTestResults([{
                        name: 'å®Œæ•´è¯Šæ–­',
                        status: 'FAILED',
                        message: error.message,
                        timestamp: new Date().toISOString()
                    }]);
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = 'ğŸ§ª å®Œæ•´è¯Šæ–­';
                });
        }
        
        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function displayTestResults(results) {
            const container = document.getElementById('testResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="alert alert-info">æš‚æ— æµ‹è¯•ç»“æœ</div>';
                return;
            }
            
            let html = '';
            results.forEach(result => {
                const isSuccess = result.status === 'PASSED' || result.status === 'UP';
                const statusClass = isSuccess ? 'success' : 'error';
                const statusIcon = isSuccess ? 'âœ…' : 'âŒ';
                
                html += `
                    <div class="test-result-item">
                        <div class="test-result-info">
                            <div class="test-result-name">${result.name}</div>
                            <div class="test-result-desc">${result.message || result.details || 'æ— è¯¦ç»†ä¿¡æ¯'}</div>
                        </div>
                        <div class="test-result-status">
                            <div class="test-result-badge ${statusClass}">${statusIcon} ${result.status}</div>
                            <div class="test-result-time">${new Date(result.timestamp).toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // å¯¼å‡ºå¥åº·æŠ¥å‘Š
        function exportHealthReport() {
            fetch('/api/management/health-report')
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `health-report-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
                });
        }
        
        // æ›´æ–°ç³»ç»Ÿèµ„æº
        function updateSystemResources() {
            // æ¨¡æ‹Ÿç³»ç»Ÿèµ„æºæ•°æ®
            const memoryUsage = Math.floor(Math.random() * 60) + 20; // 20-80%
            const cpuUsage = Math.floor(Math.random() * 40) + 10; // 10-50%
            
            updateProgressRing('memoryProgress', memoryUsage);
            document.getElementById('memoryText').textContent = memoryUsage + '%';
            document.getElementById('memoryUsed').textContent = Math.floor(512 * memoryUsage / 100) + ' MB';
            document.getElementById('memoryTotal').textContent = '512 MB';
            
            updateProgressRing('cpuProgress', cpuUsage);
            document.getElementById('cpuText').textContent = cpuUsage + '%';
            document.getElementById('cpuLoad').textContent = cpuUsage + '%';
            document.getElementById('cpuAvg').textContent = Math.floor(cpuUsage * 0.8) + '%';
            
            document.getElementById('activeConnections').textContent = Math.floor(Math.random() * 20) + 5;
            document.getElementById('totalConnections').textContent = Math.floor(Math.random() * 100) + 50;
            document.getElementById('networkLatency').textContent = Math.floor(Math.random() * 50) + 10 + 'ms';
        }
        
        // æ›´æ–°è¿›åº¦ç¯
        function updateProgressRing(elementId, percentage) {
            const circle = document.getElementById(elementId);
            const circumference = 2 * Math.PI * 26;
            const offset = circumference - (percentage / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            // æ ¹æ®ç™¾åˆ†æ¯”æ”¹å˜é¢œè‰²
            if (percentage < 50) {
                circle.style.stroke = '#28a745';
            } else if (percentage < 80) {
                circle.style.stroke = '#ffc107';
            } else {
                circle.style.stroke = '#dc3545';
            }
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
            }
        });
    </script>
</body>
</html>